<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BARCODES-PRINT</title>
    <!-- Include Tailwind CSS from a CDN -->
    <!-- <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet"> -->
    <link href="./jsbackup/tailwind.min.css" rel="stylesheet">
    <!-- Include JSBarcode library from a CDN -->
    <!-- <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script> -->
    <script src="./jsbackup/JsBarcode.all.min.js"></script>
    <!-- Load React and ReactDOM from CDN -->
    <!-- <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script> -->
    <script src="./jsbackup/react.production.min.js"></script>
    <!-- <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script> -->
    <script src="./jsbackup/react-dom.production.min.js"></script>
    <!-- Load Babel to transpile JSX -->
    <!-- <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script> -->
    <script src="./jsbackup/babel.min.js"></script>
    <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script> -->
    <script src="./jsbackup/papaparse.min.js"></script>
    <style>
        .keepspaces {
            white-space: pre;
        }
        body {
            width: 210mm;
            height: 297mm;
        }
        pre {
            white-space: pre-wrap;
        }
        .ligne1{
            width: 6cm;
            word-wrap: break-word;
            /* font-size: 1vw; */
        }
        .ligne2{
            width: 6cm;
        }
        .ligne3{
            width: 6cm;
        }
        .ligne4{
            width: 6cm;
        }
        @media print {

            .no-print,
            .no-print * {
                display: none !important;
            }
            div,
            p {
                page-break-inside: avoid;
            }
        }
    </style>
</head>

<body style="font-family: monospace">
    <div class="no-print m-4">
        <a href="./sample_file.csv.faux" class="p-2">Fichier exemple</a>
        <br />
        <br />
        <input type="file" id="csvFile" accept=".csv" />
    </div>
    <div id="root"></div>

    <script type="text/babel">

        const { useEffect, useState } = React;

        function defaultValuesWhenAbsent({ ean = '', ligne1 = '', ligne2_left = '', ligne2_right = '', ligne3 = '', ligne4_left = '', ligne4_right = '' } = {}) {
            return {
                ean_full: ean,
                ean: ean.substring(0, 12),
                ligne1,
                ligne2_left,
                ligne2_right,
                ligne3,
                ligne4_left,
                ligne4_right
            };
        }

        function BarCode({ data }) {

            console.log(data)
            const formatted_data = defaultValuesWhenAbsent(data);

            useEffect(() => {
                // Call the function to generate the barcode
                generateBarcode();

                return () => {
                    console.log('Barcode Component unmounted');
                };
            }, [formatted_data]);

            // Generate a barcode using the JSBarcode library
            function generateBarcode() {
                try {
                    JsBarcode("#barcode" + formatted_data.ean, formatted_data.ean, {
                        format: "EAN13",
                        lineColor: "#000000",
                        margin: 0,
                        width: 2,
                        height: 50,
                        // displayValue: false,
                        fontSize: 12,
                        // fontOptions: "bold",
                        font: "monospace",
                        // flat: true
                    });
                } catch (error) {
                    console.log("Erreur impression codebarre: ", formatted_data.ean, error)
                }
            }

            function generateString(str_left_side, str_right_side) {

                const str_left_side_trimmed = str_left_side?.substring(0, 24)

                const remainingLength = 36 - (str_left_side_trimmed.length + str_right_side.length);

                if (remainingLength <= 0) {
                    console.error('The total length of the two strings must be less than 50 characters.');
                    return '⬛⬛⬛';
                }

                const placeHolderChars = '                                        ';
                let placeHolderStr = '';

                for (let i = 0; i < remainingLength; i++) {
                    placeHolderStr += placeHolderChars.charAt(Math.floor(Math.random() * placeHolderChars.length));
                }

                return (str_left_side_trimmed + placeHolderStr + str_right_side);
            }

            return (
                <div class="flex m-2 break-inside-avoid">
                    <div class="bg-white border p-3 break-inside-avoid">
                        <div class="container mx-auto">
                            <div class="flex flex-wrap">
                                <div class="w-full md:w-full">
                                    <div class="block text-left text-xs w-30">
                                        {(formatted_data.ligne1=='')?
                                            <>&nbsp;</>:
                                            // <pre class="ligne1 text-center leading-none p-0">{formatted_data.ligne1}</pre>
                                            <svg viewBox="0 0 100 5">
                                                <text
                                                    x="50%" y="50%" dominant-baseline="middle"
                                                    text-anchor="middle" font-size="5"
                                                    textLength={(formatted_data.ligne1.length>30)?"100":"auto"} lengthAdjust="spacing"
                                                    >
                                                    {formatted_data.ligne1}
                                                </text>
                                            </svg>
                                        }
                                        {(formatted_data.ligne2_left=='' && formatted_data.ligne2_right=='')?
                                            <></>:
                                            <svg viewBox="0 0 100 5">
                                                <text class="keepspaces"
                                                    x="50%" y="50%" dominant-baseline="middle"
                                                    text-anchor="middle" font-size="5"
                                                    textLength={(generateString(formatted_data.ligne2_left, formatted_data.ligne2_right).length>30)?"100":"auto"}
                                                    >
                                                    {generateString(formatted_data.ligne2_left, formatted_data.ligne2_right)}
                                                </text>
                                            </svg>
                                        }
                                        
                                        
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="flex justify-center bg-gray-100">
                            <svg id={"barcode" + formatted_data.ean} width="234px" height="84px" class="my-1"></svg>
                        </div>
                        <div class="container mx-auto">
                            <div class="flex flex-wrap">

                                <div class="w-full md:w-full">
                                    <div class="text-left text-xs w-30">
                                        {(formatted_data.ligne3=='')?
                                            <></>:
                                            <svg viewBox="0 0 100 5">
                                                <text
                                                    x="50%" y="50%" dominant-baseline="middle"
                                                    text-anchor="middle" font-size="5"
                                                    textLength={(formatted_data.ligne3.length>30)?"100":"auto"} lengthAdjust="spacing"
                                                    >
                                                    {formatted_data.ligne3}
                                                </text>
                                            </svg>
                                        }
                                        {(formatted_data.ligne4_left=='' && formatted_data.ligne4_right=='')?
                                            <>&nbsp;</>:
                                            <svg viewBox="0 0 100 5">
                                                <text class="keepspaces" width="100"
                                                    x="50%" y="50%" dominant-baseline="middle"
                                                    text-anchor="middle" font-size="5"
                                                    textLength={(generateString(formatted_data.ligne4_left, formatted_data.ligne4_right).length>30)?"100":"auto"} lengthAdjust="spacing"
                                                    >
                                                    {generateString(formatted_data.ligne4_left, formatted_data.ligne4_right)}
                                                </text>
                                            </svg>
                                        }
                                        
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );

        }

        function App() {

            const [barcodes_file, setBarcodesFile] = useState([]);

            document.getElementById('csvFile').addEventListener('change', handleFileSelect, false);

            function handleFileSelect(event) {
                const file = event.target.files[0];

                if (file) {
                    Papa.parse(file, {
                        header: true,
                        complete: function (results) {
                            console.log('CSV data:', results.data);
                            processData(results.data);
                        },
                        error: function (error) {
                            console.error('Error while parsing CSV:', error);
                        },
                    });
                }
            }

            function processData(data) {
                // Process the CSV data here
                setBarcodesFile(data);
            }
            const sample_data = {
                "ligne1": "SHOULDERSTRAP-DUFFLE/MESSENGER-AJACCIO",
                "ligne4_left": "CAB622WXKDXXXXXXLLQ",
                "ligne4_right": "3701328370901",
                "ean": "3701328370901",
                "ligne2_left": "CAB622WXKDXXXXXXLLQAAA",
                "ligne2_right": "3701328370901",
                "ligne3": "MESSENGER-AJACCIO"
            }
            return (
                <div>
                    <div className="no-print m-4">
                    <h1>Exemple de rendu</h1>
                        <BarCode data={sample_data} />
                        <hr />
                    </div>
                    <div className="grid grid-cols-3 gap-2">
                        {
                            barcodes_file.map(barcode => {
                                return <BarCode data={barcode} />
                            })
                        }
                    </div>
                </div>
            );
        }

        // Render React component using createRoot
        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>

</html>